<!-- Following this tutorial: https://developer.mozilla.org/en-US/docs/Web/API/HTMLVideoElement/requestVideoFrameCallback -->
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<script defer="" src="http://localhost:8889/mystream/reader.js"></script> <!-- TODO get url dynamically from back end -->
</head>
<body>

    <canvas id="canvas"></canvas>
    <video id="video" autoplay="" hidden></video>

<script>

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext("2d");
canvas.width = 480; // TODO get from video stream
canvas.height = 360;
const updateCanvas = (now, metadata) => {
//   if (startTime === 0.0) {
//     startTime = now;
//   }

ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

//   const elapsed = (now - startTime) / 1000.0;
//   const fps = (++paintCount / elapsed).toFixed(3);
//   fpsInfo.innerText = !isFinite(fps) ? 0 : fps;
//   metadataInfo.innerText = JSON.stringify(metadata, null, 2);

  video.requestVideoFrameCallback(updateCanvas);
};

let defaultControls = false;
let reader = null;

const setMessage = (str) => {
ctx.fillText(str, 10, 50);
  console.log(str);
};

setMessage("Loading stream")

const parseBoolString = (str, defaultVal) => {
  str = (str || '');

  if (['1', 'yes', 'true'].includes(str.toLowerCase())) {
    return true;
  }
  if (['0', 'no', 'false'].includes(str.toLowerCase())) {
    return false;
  }
  return defaultVal;
};

window.addEventListener('load', () => {
  reader = new MediaMTXWebRTCReader({
    url: new URL('http://localhost:8889/mystream/whep'), // TODO get URL dynamically from backend
    onError: (err) => {
      setMessage(err);
    },
    onTrack: (evt) => {
      video.srcObject = evt.streams[0];
      video.requestVideoFrameCallback(updateCanvas);
    },
  });
});

window.addEventListener('beforeunload', () => {
  if (reader !== null) {
    reader.close();
  }
});

</script>



</body></html>