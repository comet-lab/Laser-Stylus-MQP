<!-- Following this tutorial: https://developer.mozilla.org/en-US/docs/Web/API/HTMLVideoElement/requestVideoFrameCallback -->
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<script defer="" src="http://localhost:8889/mystream/reader.js"></script> <!-- TODO get url dynamically from back end -->
</head>
<body>

    <canvas id="canvas"></canvas>
<video id="video"></video>

<script>

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext("2d");
reader = null;
canvas.width = 100;
canvas.height = 100;
let lockedSize = false;
const updateCanvas = (now, metadata) => {
//   if (startTime === 0.0) {
//     startTime = now;
//   }
  if(!lockedSize && video.videoWidth != 0) {
    lockedSize = true;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
  }

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

//   const elapsed = (now - startTime) / 1000.0;
//   const fps = (++paintCount / elapsed).toFixed(3);
//   fpsInfo.innerText = !isFinite(fps) ? 0 : fps;
//   metadataInfo.innerText = JSON.stringify(metadata, null, 2);

  video.requestVideoFrameCallback(updateCanvas);
};

const setMessage = (str) => {
  ctx.fillText(str, 10, 50);
};

setMessage("Loading stream")

window.addEventListener('load', () => {
  video.muted = true;
  video.autoplay = true;
  reader = new MediaMTXWebRTCReader({
    url: new URL('http://localhost:8889/mystream/whep'), // TODO get URL dynamically from backend
    onError: (err) => {
      setMessage(err);
    },
    onTrack: (evt) => {
      video.srcObject = evt.streams[0];
      video.requestVideoFrameCallback(updateCanvas);
    },
  });
});

window.addEventListener('beforeunload', () => {
  if (reader !== null) {
    reader.close();
  }
});

</script>



</body></html>