FROM ubuntu:20.04

WORKDIR /app

ENV DEBIAN_FRONTEND=noninteractive


RUN apt update && apt install -y wget ffmpeg python3 python3-pip
RUN wget https://github.com/bluenviron/mediamtx/releases/download/v1.15.3/mediamtx_v1.15.3_linux_amd64.tar.gz
RUN tar -xzf mediamtx_v1.15.3_linux_amd64.tar.gz

COPY requirements.txt .

RUN pip install --no-cache-dir -r requirements.txt
ENV PYTHONUNBUFFERED=1

COPY *.py .
COPY mediamtx_config.yml .

CMD sh -c './mediamtx mediamtx_config.yml & sleep 2 && \
    python3 compositor.py | \
    ffmpeg \
    -f rawvideo -pix_fmt bgr24 -s 640x480 -r 30 \
    -i pipe:0 \
    -c:v libx264 -pix_fmt yuv420p \
    -x264-params "nal-hrd=cbr" -b:v 10M -minrate 10M -bufsize 20M \
    -preset ultrafast -tune zerolatency \
    -f rtsp rtsp://localhost:8554/mystream'